---
title: "GruppenAufgaben"
author: "Gruppe 26"
date: "15 2 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Libraries einbinden

```{r libraries}
if(!require(magrittr)){
  install.packages("magrittr")
}
library(magrittr)

if(!require(tidyverse)){
  install.packages("tidyverse")
}
library(tidyverse)

if(!require(readr)){
  install.packages("readr")
}
library(readr)
```



## Aufgabe 1

Importieren Sie relevante Datensätze aus dem bereitgestellten tubcloud-Ordner. Listen sie zunächst in der Dokumentation auf, welche Dateien sie importieren.

```{r import data}
# Import Einzelteile
# Import all the relevant parts (T11, T14, T15, T16, T19, T20)

# read files with exotic delimiters in txt-files (T11, T16, T20) as string (for better performance)
einzelteil_t11_string <- read_file("Data/Einzelteil/Einzelteil_T11.txt")
einzelteil_t16_string <- read_file("Data/Einzelteil/Einzelteil_T16.txt")
einzelteil_t20_string <- read_file("Data/Einzelteil/Einzelteil_T20.txt")

# replace exotic delimiters between columns
einzelteil_t11_string <- gsub("\t", ",", einzelteil_t11_string)
einzelteil_t16_string <- gsub(" \\| \\| ", ",", einzelteil_t16_string)
einzelteil_t20_string <- gsub(" \\| \\| ", ",", einzelteil_t20_string)

# paste missing column name at first position to avoid parsing error when read_csv will be used
einzelteil_t11_string <- paste("X1_1", einzelteil_t11_string, sep = ",")
einzelteil_t16_string <- paste("X1_1", einzelteil_t16_string, sep = ",")
einzelteil_t20_string <- paste("X1_1", einzelteil_t20_string, sep = ",")

# replace exotic delimiters between rows with line breaks
einzelteil_t11_string <- gsub("", "\n", einzelteil_t11_string)
einzelteil_t16_string <- gsub("\t", "\n", einzelteil_t16_string)
einzelteil_t20_string <- gsub(" ", "\n", einzelteil_t20_string)

# write data into one csv file, respectively
write(einzelteil_t11_string, file = "Data/Einzelteil/Einzelteil_T11.csv")
write(einzelteil_t16_string, file = "Data/Einzelteil/Einzelteil_T16.csv")
write(einzelteil_t20_string, file = "Data/Einzelteil/Einzelteil_T20.csv")

# remove unused objects and return memory
einzelteil_t11_string <- ""
einzelteil_t16_string <- ""
einzelteil_t20_string <- ""
gc()

# Import final csv-files
# read_csv (delim = ","), coerce col_type for t16 because data is split on several columns which causes parsing errors
t11 <- read_csv("Data/Einzelteil/Einzelteil_T11.csv")
t16 <- read_csv("Data/Einzelteil/Einzelteil_T16.csv", col_types = c("nncDnnnDncDnnnDncDnnnDn"))
t19 <- read_csv("Data/Einzelteil/Einzelteil_T19.csv")
t20 <- read_csv("Data/Einzelteil/Einzelteil_T20.csv")

# read_csv2 (delim = ";"), coerce col_type for t15 because data is split on several columns which causes parsing errors
t14 <- read_csv2("Data/Einzelteil/Einzelteil_T14.csv")
t15 <- read_csv2("Data/Einzelteil/Einzelteil_T15.csv", col_types = c("nncDnnnDncDnnnDn"))

# Produktionsdatum_Origin_01011970 (in T11, T14, T19, T20) is an integer representing days since origin date
# Transform origin column into Class Date, use mutate to add Produktionsdatum_Origin_01011970 values to origin values
t11 <- t11 %>% 
  mutate(Produktionsdatum = as.Date(origin, format = "%d-%m-%Y") + Produktionsdatum_Origin_01011970)
t14 <- t14 %>% 
  mutate(Produktionsdatum = as.Date(origin, format = "%d-%m-%Y") + Produktionsdatum_Origin_01011970)
t19 <- t19 %>% 
  mutate(Produktionsdatum = as.Date(origin, format = "%d-%m-%Y") + Produktionsdatum_Origin_01011970)
t20 <- t20 %>% 
  mutate(Produktionsdatum = as.Date(origin, format = "%d-%m-%Y") + Produktionsdatum_Origin_01011970)

# Remove unnecessary columns
t11 <- t11 %>% select(-X1, -X1_1, -origin, -Produktionsdatum_Origin_01011970)
t14 <- t14 %>% select(-X1, -X1_1, -origin, -Produktionsdatum_Origin_01011970)
t15 <- t15 %>% select(-X1, -X1_1)
t16 <- t16 %>% select(-X1, -X1_1)
t19 <- t19 %>% select(-X1, -X1_1, -origin, -Produktionsdatum_Origin_01011970)
t20 <- t20 %>% select(-X1, -X1_1, -origin, -Produktionsdatum_Origin_01011970)

# Split the three diferent parts of T15 and T16 into three data sets
t15_part1 <- filter(t15, !is.na(ID_T15.x)) 
t15_part2 <- filter(t15, !is.na(ID_T15.y))

t16_part1 <- filter(t16, !is.na(ID_T16.x)) 
t16_part2 <- filter(t16, !is.na(ID_T16.y))
t16_part3 <- filter(t16, !is.na(ID_T16))

# Remove empty column from each data set 
t15_part1 <- t15_part1[, c(-8:-14)] 
t15_part2 <- t15_part2[, c(-1:-7)]

t16_part1 <- t16_part1[, c(-8:-21)] 
t16_part2 <- t16_part2[, c(-1:-7, -15:-21)]
t16_part3 <- t16_part3[, c(-1:-14)]

# Rename column names to the same names for all parts of T15 and T16 data set respectively
colnames(t15_part2) <- c("ID_T15", "Produktionsdatum", "Herstellernummer","Werksnummer", "Fehlerhaft", "Fehlerhaft_Datum", "Fehlerhaft_Fahrleistung" )
colnames(t15_part1) <- colnames(t15_part2)

colnames(t16_part3) <- c("ID_T16", "Produktionsdatum", "Herstellernummer","Werksnummer", "Fehlerhaft", "Fehlerhaft_Datum", "Fehlerhaft_Fahrleistung" )
colnames(t16_part2) <- colnames(t16_part3)
colnames(t16_part1) <- colnames(t16_part3)

# Bind the three datasets into one dataset, respectively
t15 <- rbind(t15_part1, t15_part2)

t16 <- rbind(t16_part1, t16_part2, t16_part3)

t15_part1 <- ""
t15_part2 <- ""
t16_part1 <- ""
t16_part2 <- ""
t16_part3 <- ""
gc()

# Produktionsdatum and Fehlerhaft_Datum into Class Date
t11[, c("Fehlerhaft_Datum", "Produktionsdatum")] <- lapply(t11[, c("Fehlerhaft_Datum", "Produktionsdatum")], as.Date, format = "%Y-%m-%d")
t14[, c("Fehlerhaft_Datum", "Produktionsdatum")] <- lapply(t14[, c("Fehlerhaft_Datum", "Produktionsdatum")], as.Date, format = "%Y-%m-%d")
t15[, c("Fehlerhaft_Datum", "Produktionsdatum")] <- lapply(t15[, c("Fehlerhaft_Datum", "Produktionsdatum")], as.Date, format = "%Y-%m-%d")
t16[, c("Fehlerhaft_Datum", "Produktionsdatum")] <- lapply(t16[, c("Fehlerhaft_Datum", "Produktionsdatum")], as.Date, format = "%Y-%m-%d")
t19[, c("Fehlerhaft_Datum", "Produktionsdatum")] <- lapply(t19[, c("Fehlerhaft_Datum", "Produktionsdatum")], as.Date, format = "%Y-%m-%d")
t20[, c("Fehlerhaft_Datum", "Produktionsdatum")] <- lapply(t20[, c("Fehlerhaft_Datum", "Produktionsdatum")], as.Date, format = "%Y-%m-%d")

# Move column Produktionsdatum to the last position in T15 and T16 in order to get the same structure for all datasets
t15 <- t15 %>% select(-Produktionsdatum, Produktionsdatum)
t16 <- t16 %>% select(-Produktionsdatum, Produktionsdatum)


#Import Komponenten

#read Komponenete_K2LE1

#read file and replace delim with single character delim
tx  <- read_file("Data/Komponente/Komponente_K2LE1.txt")
tx2 <- gsub(pattern = "II", replace = ";", x = tx, fixed = TRUE)
#add Newline when needed so that table has table structure
tx3 <- unlist(strsplit(tx2, ";")) # unlist is here to convert to a vector
tx3 <- split(tx3, ceiling(seq_along(tx3)/15))
out <- sapply(tx3, function(x) paste0(x, collapse = ";"))
#write output in temp file and read temp file 
myFile <- tempfile()
writeLines(out, con=myFile)
#read Komponente
komponente_k2le1 <- read_delim(myFile, delim = ";", col_types = c("ncDnnnDncDnnnDc")) %>%
  select(-X1)

#split table in two (x and y)
komponente_k2le1.x <- komponente_k2le1 %>%
  select(1:7) %>%
  #filter out those where ID is na
  filter(!is.na(ID_Sitze.x)) %>%
  rename(
    ID_Sitze = ID_Sitze.x,
    Produktionsdatum = Produktionsdatum.x,
    Herstellernummer = Herstellernummer.x,
    Werksnummer = Werksnummer.x,
    Fehlerhaft = Fehlerhaft.x,
    Fehlerhaft_Datum = Fehlerhaft_Datum.x,
    Fehlerhaft_Fahrleistung = Fehlerhaft_Fahrleistung.x,
  )
komponente_k2le1.y <- komponente_k2le1 %>%
  select(8:14) %>%
  #filter out those where ID is na
  filter(!is.na(ID_Sitze.y)) %>%
  #split column into two because there was no delim in original file between them, keep just necessary information
  mutate(Fehlerhaft_Fahrleistung = as.numeric(strsplit(`Fehlerhaft_Fahrleistung.y""1`, split = "\"", fixed = TRUE)[[1]][1])) %>%
  select(-`Fehlerhaft_Fahrleistung.y""1`) %>%
  rename(
    ID_Sitze = ID_Sitze.y,
    Produktionsdatum = Produktionsdatum.y,
    Herstellernummer = Herstellernummer.y,
    Werksnummer = Werksnummer.y,
    Fehlerhaft = Fehlerhaft.y,
    Fehlerhaft_Datum = Fehlerhaft_Datum.y
  )

#bind the two tables (x and y) together again the right way
komponente_k2le1 <- bind_rows(komponente_k2le1.x, komponente_k2le1.y) %>%
  mutate(Komponente = "K2LE1")
  
#read Komponenete_K2LE2
#read file because first column name is missing
temp1 <- read_file("Data/Komponente/Komponente_K2LE2.txt")
#add first column name
temp2 <- paste("X2", temp1, sep = "\\")
#write into temporary file
myFile2 <- tempfile()
writeLines(temp2, con=myFile2)

#read file
komponente_k2le2 <- read_delim(myFile2, delim = "\\") %>%
  #format origin in date format and create Produktionsdatum
  mutate(origin = as.Date(origin, format = "%d-%m-%Y"), Produktionsdatum = as.Date(Produktionsdatum_Origin_01011970, origin = origin)) %>%
  select(-X1, -X2, -origin, -Produktionsdatum_Origin_01011970) %>%
  mutate(Komponente = "K2LE2")

#bind tables into one and check if IDs are correct
komponenten <- bind_rows(komponente_k2le1, komponente_k2le2) %>%
   mutate(id_richtig_komp =
           isTRUE(
              #check if ID-Herstellernr and Herstellernr match
              strsplit(ID_Sitze, split = "-", fixed = TRUE)[[1]][2] == Herstellernummer && 
              #check if ID-Werksnr and Werksnr match
              strsplit(ID_Sitze, split = "-", fixed = TRUE)[[1]][3] == Werksnummer &&
              #check if Herstellernr and Herstellernr in Werksnr match
              Herstellernummer == as.numeric(substring(Werksnummer, 1, nchar(Herstellernummer))) &&
              #check if ID-Komponente and Komponente match
              strsplit(ID_Sitze, split = "-", fixed = TRUE)[[1]][1] == Komponente
            )
  )

#if all IDs are correct, delete redundant columns
if(all(komponenten$id_richtig_komp == TRUE)){
  komponenten <- komponenten %>%
    select(-id_richtig_komp, -Herstellernummer, -Werksnummer, -Komponente)
}


#Import Fahrzeuge und deren Bestandteile

#read Fahrzeuge and deselect unnecessary columns and mutate a type column for a later check
#transform origin in date format and create Produktionsdatum
fahrzeug_oem1_typ11 <- read_csv("Data/Fahrzeug/Fahrzeuge_OEM1_Typ11.csv") %>%
  select(-X1, -X1_1) %>%
  mutate(Fahrzeugtyp = 11)
fahrzeug_oem1_typ12 <- read_csv2("Data/Fahrzeug/Fahrzeuge_OEM1_Typ12.csv") %>%
  select(-X1, -X1_1) %>%
  mutate(Fahrzeugtyp = 12)
fahrzeug_oem2_typ21 <- read_csv("Data/Fahrzeug/Fahrzeuge_OEM2_Typ21.csv") %>%
  mutate(origin = (as.Date(origin, format = "%d-%m-%Y")), Produktionsdatum = as.Date(Produktionsdatum_Origin_01011970, origin = origin)) %>%
  select(-X1, -X1_1, -origin, -Produktionsdatum_Origin_01011970) %>%
  mutate(Fahrzeugtyp = 21)
fahrzeug_oem2_typ22 <- read_csv2("Data/Fahrzeug/Fahrzeuge_OEM2_Typ22.csv") %>%
  mutate(origin = (as.Date(origin, format = "%d-%m-%Y")), Produktionsdatum = as.Date(Produktionsdatum_Origin_01011970, origin = origin)) %>%
  select(-X1, -X1_1, -origin, -Produktionsdatum_Origin_01011970) %>%
  mutate(Fahrzeugtyp = 22)

#bind Fahrzeuge together in one table, check if IDs are correct
all_fahrzeuge <- bind_rows(fahrzeug_oem1_typ11, fahrzeug_oem1_typ12) %>%
  bind_rows(fahrzeug_oem2_typ21) %>%
  bind_rows(fahrzeug_oem2_typ22) %>%
  mutate(id_richtig_fahrzeuge = isTRUE(
              #check if ID-Herstellernr and Herstellernr match
              substring(ID_Fahrzeug, 4, 4) == Herstellernummer && 
              #check if ID-Werksnr and Werksnr match
              substring(ID_Fahrzeug, 6, 7) == Werksnummer &&
              #check if Herstellernr and number in Werksnr match
              Herstellernummer == as.numeric(substring(Werksnummer, 1, nchar(Herstellernummer))) &&
              # check if Fahrzeug has correct type
              substring(ID_Fahrzeug, 1, 2) == Fahrzeugtyp
  ))

#if all IDs are correct, deselect redundant columns
if(all(all_fahrzeuge$id_richtig_fahrzeuge == TRUE)){
  all_fahrzeuge <- all_fahrzeuge %>%
    select(-id_richtig_fahrzeuge, -Herstellernummer, -Werksnummer, -Fahrzeugtyp)
}

#read Bestandteile_Fahrzeuge
bestandteile_oem1_typ11 <- read_csv2("Data/Fahrzeug/Bestandteile_Fahrzeuge_OEM1_Typ11.csv") %>%
  select(ID_Sitze, ID_Fahrzeug)
bestandteile_oem1_typ12 <- read_csv2("Data/Fahrzeug/Bestandteile_Fahrzeuge_OEM1_Typ12.csv") %>%
  select(ID_Sitze, ID_Fahrzeug)
bestandteile_oem2_typ21 <- read_csv2("Data/Fahrzeug/Bestandteile_Fahrzeuge_OEM2_Typ21.csv") %>%
  select(ID_Sitze, ID_Fahrzeug)
bestandteile_oem2_typ22 <- read_csv2("Data/Fahrzeug/Bestandteile_Fahrzeuge_OEM2_Typ22.csv") %>%
  select(ID_Sitze, ID_Fahrzeug)

#bind Bestandteile together in one table and check if IDs correct
fahrzeug_bestandteile <- bind_rows(bestandteile_oem1_typ11, bestandteile_oem1_typ12) %>%
  bind_rows(bestandteile_oem2_typ21) %>%
  bind_rows(bestandteile_oem2_typ22) %>%
  mutate(id_richtig_fahrz_bestandteile = isTRUE(
      #check if Herstellernr and number in Werksnummer match in ID_Sitze
      substring(ID_Sitze, 7, 9) == substring(ID_Sitze, 11, 13) &&
      #check if Herstellernr and number in Werksnummer match in ID_Fahrzeuge
      substring(ID_Fahrzeug, 4, 4) == substring(ID_Fahrzeug, 6, 6)
  ))

#if all IDs are correct, deselect redundant columns
if(all(fahrzeug_bestandteile$id_richtig_fahrz_bestandteile == TRUE)){
  fahrzeug_bestandteile <- fahrzeug_bestandteile %>%
    select(-id_richtig_fahrz_bestandteile)
}

#join Fahrzeuge and Bestandteile
#transform dates in correct format
fahrzeuge <- full_join(all_fahrzeuge, fahrzeug_bestandteile, by = "ID_Fahrzeug") %>%
  mutate(Produktionsdatum = as.Date(Produktionsdatum, format = "%Y-%m-%d"),
         Fehlerhaft_Datum = as.Date(Fehlerhaft_Datum, format = "%Y-%m-%d"))

```

## Aufgabe 2

Bereiten Sie die für Ihre Aufgabe relevanten Daten nach den Prinzipien von tidy data auf und fügen Sie diese in einem einzigen Datensatz zusammen.

```{r tidy data}
# Tidy data
```

## Aufgabe 3

Entwickeln Sie eine Shiny-App welche folgende Kriterien erfüllt:
Alle verwendeten Packages müssen auf der aktuellen R-Version lauffähig sein.
Die Applikation muss ohne weitere Anpassungen aus dem Abgabeordner gestartet werden können. Es bietet sich an, dies vor Abgabe zu testen. Die Applikation soll sich nur auf einen einzelnen, von Ihnen erstellten Datensatz beziehen.
Das Layout der Applikation soll auf die Zielgruppe angepasst sein und der Unternehmensfarbe entsprechen. Die Farbe ihres Unternehmens ist TUB-Rot. Des Weiteren soll ein Logo in das Layout integriert werden. Es kann ein eigenes Logo erstellt werden, oder das Logo vom Fachgebiet Qualitätswissenschaft verwendet werden. Passen Sie die Schriftart ihrer Applikation nach Ihren wünschen an. Eine Anpassung ist obligatorisch.

```{r shiny app}
# Shiny Server
# Shiny App
```

## Aufgabe 4

Visualisieren Sie folgendes in der Applikation
a. Einen Graphen, der den zeitlichen Zulassungsverlauf der betroffenen Fahrzeuge in den Gemeinden darstellt. Verwenden Sie zusätzlich eine Heatmapdarstellung zur Visualisierung von Schadensschwerpunkten. Integrieren Sie Popups in die Kartendarstellung, die Informationen zu den zugelassenen Fahrzeugen enthalten.
b. Den Lieferweg (als Luftlinie) für ein betroffenes Bauteil, welches vom Benutzer ausgewählt werden kann.
c. Den Fahrzeughaltern soll es möglich sein, (bspw. über ein Suchfeld) anhand der Fahrzeug-ID zu überprüfen, ob ihr Auto betroffen ist.
d. Ihren zugrundeliegenden Datensatz als Tabelle, damit Sie Visualisiertes auch beweisen können. Denken Sie auch hier daran, nur die notwendigen Attribute anzuzeigen.

```{r plot data}
# a) Plot data 'zeitlichen Zulassungsverlauf'
ggplot()
# b) Plot data 'Lieferweg (als Luftlinie) für ein betroffenes Bauteil'
# c) ID tracker
# d) Print table
```

## Aufgabe 5

Dokumentieren Sie die Ergebnisse Ihrer Analyse in einer R Markdown Datei. Beschreiben Sie Ihren Datenanalyseprozess schrittweise und diskutieren Sie das Ergebnis anhand aussagekräftiger Graphiken aus Ihrer entwickelten App. Das Beschreiben Ihres Vorgehens dient der Nachvollziehbarkeit Ihrer Lösungsschritte. Falls es Probleme mit Ihrem R-Code gibt, kann durch die Dokumentation ein grundsätzlich richtiges Vorgehen anerkannt werden. Kommentieren Sie deshalb Ihren Code sorgfältig und beachten Sie den tidyverse Style-Guide. Erstellen Sie ein Inhaltsverzeichnis, welches im html-File eingeblendet wird und anklickbar ist. Folgende Gliederungspunkte sollen im Inhaltsverzeichnis mindestens aufgeführt werden:
Importieren der Daten Datenaufbereitung
Erstellen des finalen Datensatzes Auswertung
Ergebnis

```{r TOC}
# Table of Contents
```

## Aufgabe 6

Im Abgabeordner sollen folgende Dateien zu finden sein, XX ist mit der Gruppennummer zu ersetzen:
- Final_Data_Group_XX
- General_Tasks_Group_XX.rmd
- General_Tasks_Group_XX.html
- Case_Study_Group_XX.rmd
- Case_Study_Group_XX.html
- Case_study_App_XX.r